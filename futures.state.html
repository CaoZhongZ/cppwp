<!DOCTYPE html><html lang='en'><head><title>[futures.state]</title><meta charset='UTF-8'/><link rel='stylesheet' type='text/css' href='14882.css'/><link rel='icon' href='icon.png'/></head><body><div class='wrapper'><h1 ><a class='secnum' style='min-width:73pt'>30</a> Thread support library <a class='abbr_ref' href='./#thread'>[thread]</a></h1><h2 ><a class='secnum' style='min-width:88pt'>30.6</a> Futures <a class='abbr_ref' href='futures#state'>[futures]</a></h2><div id='futures.state'><h3 ><a class='secnum' style='min-width:103pt'>30.6.5</a> Shared state <a class='abbr_ref'>[futures.state]</a></h3><div class='para' id='1'><div class='marginalizedparent'><a class='marginalized' href='#1'>1</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/d2263429a07205edf8d2ffcd6d41cfe5d61544f8/source/threads.tex#L3687'>#</a></div><p >Many of the classes introduced in this subclause use some state to communicate results. This
<span class='indexparent'><a class='index' id='shared_state'></a></span>
<a class='hidden_link' href='#def:future,shared_state' id='def:future,shared_state'><i>shared state</i></a> consists of some state information and some (possibly not
yet evaluated) <a class='hidden_link' href='#def:result' id='def:result'><i>result</i></a>, which can be a (possibly void) value or an exception. [<span style='white-space:nowrap'>&thinsp;</span><i>Note:</i>
Futures, promises, and tasks defined in this clause reference such shared state. <i><span style='white-space:nowrap'>&thinsp;</span>—<span style='white-space:nowrap'>&thinsp;</span>end note</i><span style='white-space:nowrap'>&thinsp;</span>]</p></div><div class='para' id='2'><div class='marginalizedparent'><a class='marginalized' href='#2'>2</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/d2263429a07205edf8d2ffcd6d41cfe5d61544f8/source/threads.tex#L3694'>#</a></div><p >[<span style='white-space:nowrap'>&thinsp;</span><i>Note:</i> The result can be any kind of object including a function to compute that result,
as used by <span class='texttt'>async</span> when <span class='texttt'>policy</span> is <span class='texttt'>launch&#x200b;::&#x200b;deferred</span>. <i><span style='white-space:nowrap'>&thinsp;</span>—<span style='white-space:nowrap'>&thinsp;</span>end note</i><span style='white-space:nowrap'>&thinsp;</span>]</p></div><div class='para' id='3'><div class='marginalizedparent'><a class='marginalized' href='#3'>3</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/d2263429a07205edf8d2ffcd6d41cfe5d61544f8/source/threads.tex#L3698'>#</a></div><p >An <a class='hidden_link' href='#def:asynchronous_return_object' id='def:asynchronous_return_object'><i>asynchronous return object</i></a> is an object that reads results from a
shared state. A <a class='hidden_link' href='#def:waiting_function' id='def:waiting_function'><i>waiting function</i></a> of an asynchronous return object is one
that potentially blocks to wait for the shared state to be made
ready.
If a waiting function can return before the state is made ready because of a
timeout (<a href='thread.req.lockable'>[thread.req.lockable]</a>), then it is a <a class='hidden_link' href='#def:timed_waiting_function' id='def:timed_waiting_function'><i>timed waiting function</i></a>, otherwise
it is a <a class='hidden_link' href='#def:non-timed_waiting_function' id='def:non-timed_waiting_function'><i>non-timed waiting function</i></a>.</p></div><div class='para' id='4'><div class='marginalizedparent'><a class='marginalized' href='#4'>4</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/d2263429a07205edf8d2ffcd6d41cfe5d61544f8/source/threads.tex#L3707'>#</a></div><p >An <a class='hidden_link' href='#def:asynchronous_provider' id='def:asynchronous_provider'><i>asynchronous provider</i></a> is an object that provides a result to a shared
state.
The result of a shared state is set by
respective functions on the asynchronous provider. [<span style='white-space:nowrap'>&thinsp;</span><i>Note:</i> Such as promises or tasks.
<i><span style='white-space:nowrap'>&thinsp;</span>—<span style='white-space:nowrap'>&thinsp;</span>end note</i><span style='white-space:nowrap'>&thinsp;</span>] The means of setting the result of a shared state is specified
in the description of those classes and functions that create such a state object.</p></div><div class='para' id='5'><div class='marginalizedparent'><a class='marginalized' href='#5'>5</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/d2263429a07205edf8d2ffcd6d41cfe5d61544f8/source/threads.tex#L3715'>#</a></div><p >When an asynchronous return object or an asynchronous provider is said to release its
shared state, it means:</p><ul class='itemize'><li id='5.1'><div class='marginalizedparent' style='left:-7em'><a class='marginalized' href='#5.1'>(5.1)</a></div><p >if the return object or provider holds the last reference to its shared state,
the shared state is destroyed; and</p></li><li id='5.2'><div class='marginalizedparent' style='left:-7em'><a class='marginalized' href='#5.2'>(5.2)</a></div><p >the return object or provider gives up its reference to its shared state; and</p></li><li id='5.3'><div class='marginalizedparent' style='left:-7em'><a class='marginalized' href='#5.3'>(5.3)</a></div><p >these actions will not block for the shared state to become ready, except that it
may block if all of the following are true: the shared state was created by a call to
<span class='texttt'>std&#x200b;::&#x200b;async</span>, the shared state is not yet ready, and this was the last reference
to the shared state.
</p></li></ul></div><div class='para' id='6'><div class='marginalizedparent'><a class='marginalized' href='#6'>6</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/d2263429a07205edf8d2ffcd6d41cfe5d61544f8/source/threads.tex#L3733'>#</a></div><p >When an asynchronous provider is said to make its shared state ready, it means:</p><ul class='itemize'><li id='6.1'><div class='marginalizedparent' style='left:-7em'><a class='marginalized' href='#6.1'>(6.1)</a></div><p >first, the provider marks its shared state as ready; and</p></li><li id='6.2'><div class='marginalizedparent' style='left:-7em'><a class='marginalized' href='#6.2'>(6.2)</a></div><p >second, the provider unblocks any execution agents waiting for its shared
state to become ready.
</p></li></ul></div><div class='para' id='7'><div class='marginalizedparent'><a class='marginalized' href='#7'>7</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/d2263429a07205edf8d2ffcd6d41cfe5d61544f8/source/threads.tex#L3745'>#</a></div><p >When an asynchronous provider is said to abandon its shared state, it means:</p><ul class='itemize'><li id='7.1'><div class='marginalizedparent' style='left:-7em'><a class='marginalized' href='#7.1'>(7.1)</a></div><p >first, if that state is not ready, the provider</p><ul class='itemize'><li id='7.1.1'><div class='marginalizedparent' style='left:-9em'><a class='marginalized' href='#7.1.1'>(7.1.1)</a></div><p >stores an exception object of type <span class='texttt'>future_&shy;error</span> with an error condition of
<span class='texttt'>broken_&shy;promise</span> within its shared state; and then</p></li><li id='7.1.2'><div class='marginalizedparent' style='left:-9em'><a class='marginalized' href='#7.1.2'>(7.1.2)</a></div><p >makes its shared state ready;
</p></li></ul></li><li id='7.2'><div class='marginalizedparent' style='left:-7em'><a class='marginalized' href='#7.2'>(7.2)</a></div><p >second, the provider releases its shared state.
</p></li></ul></div><div class='para' id='8'><div class='marginalizedparent'><a class='marginalized' href='#8'>8</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/d2263429a07205edf8d2ffcd6d41cfe5d61544f8/source/threads.tex#L3765'>#</a></div><p >A shared state is <a class='hidden_link' href='#def:ready' id='def:ready'><i>ready</i></a> only if it holds a value or an exception ready for
retrieval.
Waiting for a shared state to become ready may invoke code to compute the result on 
the waiting thread if so specified in the description of the class or function that creates
the state object.</p></div><div class='para' id='9'><div class='marginalizedparent'><a class='marginalized' href='#9'>9</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/d2263429a07205edf8d2ffcd6d41cfe5d61544f8/source/threads.tex#L3772'>#</a></div><p >Calls to functions that successfully set the stored result of a shared
state synchronize
with (<a href='intro.multithread'>[intro.multithread]</a>) calls to functions
successfully detecting the ready state resulting from that setting.
The storage of the result
(whether normal or exceptional) into the shared state
synchronizes with (<a href='intro.multithread'>[intro.multithread]</a>)
the successful return from a call to a waiting function on the shared state.</p></div><div class='para' id='10'><div class='marginalizedparent'><a class='marginalized' href='#10'>10</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/d2263429a07205edf8d2ffcd6d41cfe5d61544f8/source/threads.tex#L3782'>#</a></div><p >Some functions (e.g., <span class='texttt'>promise&#x200b;::&#x200b;set_&shy;value_&shy;at_&shy;thread_&shy;exit</span>) delay making
the shared state ready until the calling thread exits. The destruction of
each of that thread's objects with thread storage duration (<a href='basic.stc.thread'>[basic.stc.thread]</a>)
is sequenced before making that shared state ready.</p></div><div class='para' id='11'><div class='marginalizedparent'><a class='marginalized' href='#11'>11</a></div><div class='sourceLinkParent'><a class='sourceLink' href='https://github.com/cplusplus/draft/tree/d2263429a07205edf8d2ffcd6d41cfe5d61544f8/source/threads.tex#L3788'>#</a></div><p >Access to the result of the same shared state may conflict (<a href='intro.multithread'>[intro.multithread]</a>).
[<span style='white-space:nowrap'>&thinsp;</span><i>Note:</i> This explicitly specifies that the result of the shared state is
visible in the objects that reference this state in the sense of data race
avoidance (<a href='res.on.data.races'>[res.on.data.races]</a>). For example, concurrent accesses through
references returned by <span class='texttt'>shared_&shy;future&#x200b;::&#x200b;get()</span> (<a href='futures.shared_future'>[futures.shared_future]</a>)
must either use read-only operations or provide additional synchronization.
<i><span style='white-space:nowrap'>&thinsp;</span>—<span style='white-space:nowrap'>&thinsp;</span>end note</i><span style='white-space:nowrap'>&thinsp;</span>]</p></div></div></div></body></html>